<!-- views/pages/chat.ejs -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/chat_style.css">
</head>
<body>

  <div id="toRead" class="inset">
  </div>
  <div id="toSend" class="inset">
  </div>

  <script src="https://code.jquery.com/jquery-3.1.1.min.js" crossorigin="anonymous"></script>
  <script>
    var name = <%- JSON.stringify(name) %>;
    var index = 0;
    var c = <%- JSON.stringify(convo) %>;    
    var cID = -1;
    for(i=0; i<c.length; i++) {
      if(c[i].start) {
        cID = i;
      } else {
        break;
      }
    }

    console.log(cID);

    var c1 = [
      {
        'a': 'Dragonfly439',
        'm': 'Hello there. We’ve been expecting you.',
        'next': [1]
      },
      {
        'a': 'player',
        'm': 'What is going on here?',
        'next': [2]
      },
      {
        'a': 'Dragonfly439',
        'm': 'You have found a way out of the illusion of time. Now you are witness for your race.',
        'next': [3, 4, 5]
      },
      {
        'a': 'player',
        'm': 'This can’t be real. How are you doing this?',
        'next': [7]
      },
      {
        'a': 'player',
        'm': 'Please leave me alone.',
        'next': [6]
      },
      {
        'a': 'player',
        'm': 'Who are you?',
        'next': [6]
      },
      {
        'a': 'Dragonfly439',
        'm': 'You cannot get away from your own shadow.',
        'next': [3, 4, 5]
      },
      {
        'a': 'Dragonfly439',
        'm': 'But it is. This is occurring through means far beyond your Y2K world.',
        'next': [8]
      },
      {
        'a': 'player',
        'm': 'But how do I know that any of this is real?',
        'next': [9]
      },
      {
        'a': 'Dragonfly439',
        'm': 'Here’s a start. This man, <a href="/alton/mayor/altered" target="_blank">Layne Thompson</a>.',
        'next': []
      }
    ];

    var c2 = [   
      {
        'a': 'Dragonfly439',
        'm': 'Ah there you are. Enjoying yourself?',
        'next': [1]
      },
      {
        'a': 'player',
        'm': 'Alright stop this crap. What the hell is going on? I demand you! You think this is a game? A joke? Just a story? You think you’re so powerful? So clever? These are government matters here! You won’t be able to get away with this! They will track you down.',
        'next': [2]
      },
      {
        'a': 'Dragonfly439',
        'm': 'Oh that’s good. Don’t flatter yourself or your government too much, they’re not nearly as adept as they lead their citizens to believe. Just as it is written, Hubris truly is a deadly sin. Always remember that.',
        'next': [3, 4, 5]
      },
      {
        'a': 'player',
        'm': 'I could say the same of you.',
        'next': [6]
      },
      {
        'a': 'player',
        'm': 'Can you at least skip the biblical?',
        'next': [7]
      },
      {
        'a': 'player',
        'm': 'What do you want? What do you want me to do?',
        'next': [8]
      },
      {
        'a': 'Dragonfly439',
        'm': 'Haha you are too funny. Or maybe you are even more naive than I assumed. You think you see, but your true eye has not been opened. The Sight will come.',
        'next': [9]
      },
      {
        'a': 'Dragonfly439',
        'm': 'Funny. Or maybe you are even more naive than I assumed. You think you see, but your true eye has not been opened. The Sight will come.',
        'next': [9]
      },
      {
        'a': 'Dragonfly439',
        'm': 'I want you to understand. To find knowledge and truth. There are many who are mislead, who only see what they want to, but not the world as it truly is.',
        'next': [9]
      },
      {
        'a': 'player',
        'm': 'Okay, so how do I find this sight?',
        'next': [10]
      },
      {
        'a': 'Dragonfly439',
        'm': '<a href=”/” target=”_blank”>Search here and within yourself. You might find that they’re not very different.</a>',
        'next': []
      }
    ];

    var cs = [c1, c2];

    if(cID > -1) {
      var convo = cs[cID];
      AIMessage();
    }  else {
      var result = '<p><b class="no-messages">You have no current conversations.</b></p>';
      $('#toRead').append(result);
    }

    function putInRead() {
      var line = convo[index];
      var result = '<p><b class="'
      if(line.a == 'Dragonfly439') {
        result += 'red">' + line.a;
      } else {
        result += 'blue">' + name;
      }
      result += ': </b>' + line.m + '</p>';
      $('#toRead').append(result);
      $('#toRead').scrollTop($('#toRead')[0].scrollHeight);
    }

    function putInSend() {
      var lines = convo[index].next;
      if(lines.length) {
        var result = '';
        for(var i = 0; i < lines.length; i++) {
          result += '<button value="' + lines[i] + '"><b class="blue">' + (i + 1) + ': </b>' + convo[lines[i]].m + '</button>';
        }
        $res = $(result);
        $('#toSend').append($res);
        $res.click(sendMessage);
      } else {
        c[cID].end = true;
          
        $.ajax({
          type: 'POST',
          data: JSON.stringify(c),
          contentType: 'application/json',
          url: '/chat',            
          success: function(data) {
            console.log('success');
          }
        });
      }
    }

    function AIMessage() {
      putInRead();
      setTimeout(putInSend, 1000);
    }

    function sendMessage() {
      index = $(this).val();
      $('#toSend').empty();
      putInRead();
      index = convo[index].next[0];
      setTimeout(AIMessage, 2000);
    }
  </script>

</body>
</html>
